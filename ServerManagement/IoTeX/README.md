# Server Setup, Configuration, and Management for IoTeX

## Pre-requisites:

There are several Prerequisites needed to to run an IoTeX Validator. Among them are docker and Golang. Directions for 
setting up your dev environment properly before installing IoTeX and Running the Server may be found below
```
sudo apt-get update
sudo apt-get upgrade

sudo apt install curl git bison gcc make jq
```

Add your private github key

```ssh-keygen -t rsa -b 4096 -C "your_email@example.com"```

Go to: ~/.ssh/id_rsa.pub 

copy the public key there

add it to your github profile under settings>SSH and GPG keys

Golang
https://golang.org/

***Installing Go is the most important part of this, most errors you receive down the line are
the result of an improper Go installation***

```
Wget the most up to date version
tar -C /usr/local -xzf go$VERSION.$OS-$ARCH.tar.gz
```
Then, open $HOME/.profile and add this to the path:
```
PATH=$PATH:/usr/local/go/bin
GOPATH=$HOME/go
PATH=$PATH:$GOPATH/bin
```
Once complete ```source .profile``` to update the active path

create directories $HOME/go/bin

***Dep***
https://golang.github.io/dep/

***Protoc***
```
sudo apt-get install autoconf automake libtool curl make g++ unzip
wget https://github.com/protocolbuffers/protobuf/releases/download/v3.6.1/protobuf-all-3.6.1.tar.gz
sudo tar xvzf protobuf-all-3.6.1.tar.gz
cd protobuf-all-3.6.1
sudo ./configure
sudo make
sudo make check
sudo make install
sudo ldconfig
```
Install docker
```
sudo snap install docker
```
make sure it's working correctly
```
sudo docker run hello-world
```
Add docker to users so you don't need sudo:

Create the docker group.

```sudo groupadd docker```

Add your user to the docker group.

```sudo usermod -aG docker $USER```

Log out and log back in so that your group membership is re-evaluated. (you may need to reboot)

## Install IoTeX

```
mkdir -p ~/go/src/github.com/iotexproject
cd ~/go/src/github.com/iotexproject
git clone git@github.com:iotexproject/iotex-core.git
cd iotex-core
make
```

Build the project by
```
make docker
```
Note that if your enviroment is in Linux, you need to add the share libraries into $LD_LIBRARY_PATH by
```
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$GOPATH/src/github.com/iotexproject/iotex-core/crypto/lib
```
Download the config and genesis files for the mainnet or testnet server you are spinnning up
by cloning the appropriate git repo. An Example with a ***testnet*** server is shown below.
```
git clone https://github.com/iotexproject/iotex-testnet
```

Make 3 new directories and copy the genesis and config files into the /etc file:
```
mkdir -p $IOTEX_HOME/data
mkdir -p $IOTEX_HOME/log
mkdir -p $IOTEX_HOME/etc
cp config.yaml $IOTEX_HOME/etc/
cp genesis.yaml $IOTEX_HOME/etc/
```
Open the config file and change the 127.0.0.1 after 'host:' to your external IP address.
For example, if your external IP is 30.30.30.30:
```
# replace with your external IP address
host: "30.30.30.30"
```

Additionally, add your private key into config.yaml, generated by ```ioctl account create```
***Alternatively*** 

You can start from a snapshot by running the following commands. I find this to be significantly easier and much faster.
```
curl -L https://t.iotex.me/mainnet-data-latest > $IOTEX_HOME/data.tar.gz
tar -xzf data.tar.gz
```
## Running the Node

If this is a new node, pull the most recent testnet or mainnet data snapshot per the instructions on the git
and place in the /data folder

Run the full node: Pay attention to the path to the config and genesis files!
```
docker run -d --restart on-failure --name iotex \
        -p 4689:4689 \
        -p 14014:14014 \
        -p 8080:8080 \
        -v=$IOTEX_HOME/data:/var/data:rw \
        -v=$IOTEX_HOME/log:/var/log:rw \
        -v=$IOTEX_HOME/etc/config.yaml:/etc/iotex/config_override.yaml:ro \
        -v=$IOTEX_HOME/etc/genesis.yaml:/etc/iotex/genesis.yaml:ro \
        iotex/iotex-core:v0.8.3 \
        iotex-server \
        -config-path=/etc/iotex/config_override.yaml \
        -genesis-path=/etc/iotex/genesis.yaml \
        -plugin=gateway
```
to make your node not available to api calls: remove
```
-p 10414:14014 \
-plugin=gateway
```

```docker logs -f --tail 20 iotex | sed 's/,"errorVerbose":"[^"]*"//g' | jq``` Nice way to view logs as it starts up

To install a new version, you'll need to delete the data in your data and log folders and pull a new genesis and config file

Running this should show you container information
```
sudo docker container ls
```

get the cli, iotcl:
```
curl https://raw.githubusercontent.com/iotexproject/iotex-core/master/install-cli.sh | sh
```

Can build an app in heroku: 
create new app>manage app>settings>reveal config vars

## Operating Your Node

### Checking node logs
```
docker logs iotex
```

### Stoping and removing container
```
docker stop iotex
docker rm iotex
```

### Pausing and Restarting IoTeX
```
docker stop iotex
docker start iotex
```

### Updating IoTeX Node
```
docker stop iotex
docker rm iotex
curl -L https://t.iotex.me/mainnet-data-latest > $IOTEX_HOME/data.tar.gz
tar -xzf data.tar.gz
```
Then run the following Command with the version of IoTeX you are upgrading to ***v0.8.3*** at time of writing
```
docker run -d --restart on-failure --name iotex \
        -p 4689:4689 \
        -p 14014:14014 \
        -p 8080:8080 \
        -v=$IOTEX_HOME/data:/var/data:rw \
        -v=$IOTEX_HOME/log:/var/log:rw \
        -v=$IOTEX_HOME/etc/config.yaml:/etc/iotex/config_override.yaml:ro \
        -v=$IOTEX_HOME/etc/genesis.yaml:/etc/iotex/genesis.yaml:ro \
        iotex/iotex-core:v0.8.3 \
        iotex-server \
        -config-path=/etc/iotex/config_override.yaml \
        -genesis-path=/etc/iotex/genesis.yaml \
        -plugin=gateway
```
